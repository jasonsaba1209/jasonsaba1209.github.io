<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Login</title>
    <style>
        #user-info { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            display: none; 
        }
        #track-list {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Hey there </h1> 
    <p>Click the button below to log in to your Spotify account.</p> 
    <button id="login-btn">Login with Spotify</button>

    <div id="user-info">
        <img id="user-avatar" src="" alt="Profile Picture" width="50" height="50">
        <span id="username"></span>
        <p id="user-id"></p>
        <button id="logout-btn">Logout</button>
    </div>

    <h2>Your Listening History</h2>
    <ul id="track-list"></ul>

    <script>
        const clientId = '601b3a7ccc284046900faa1f901c21c6';
        const redirectUri = 'https://jasonsaba1209.github.io/'; 
        const scopes = ['user-read-playback-state', 'user-read-currently-playing','user-read-recently-played', 'user-read-private', 'user-read-email'];
        const authUrl = 'https://accounts.spotify.com/authorize';
        const tokenUrl = 'https://accounts.spotify.com/api/token';
        
        function initiateSpotifyLogin() {
            const params = new URLSearchParams({
                client_id: clientId,
                response_type: 'code',
                redirect_uri: redirectUri,
                scope: scopes.join(' '),
            });
            window.location.href = `${authUrl}?${params.toString()}`;
        }

        async function fetchAccessToken(code) {
            const response = await fetch(tokenUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: redirectUri,
                    client_id: clientId,
                    client_secret: '80993a1fcc614f0aaf7f57d7d9ec0f36'
                })
            });

            const data = await response.json();
            if (data.access_token) {
                localStorage.setItem('spotify_token', data.access_token);
                fetchUserProfile(data.access_token);
            }
        }

        async function fetchUserProfile(token) {
            const response = await fetch('https://api.spotify.com/v1/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const userData = await response.json();
            if (userData.id) {
                localStorage.setItem('spotify_user_id', userData.id); // Store user ID
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('username').textContent = userData.display_name;
                document.getElementById('user-avatar').src = userData.images.length > 0 ? userData.images[0].url : 'default-avatar.png';
                
                /*document.getElementById('user-id').textContent = `User ID: ${userData.id}`;*/
                
                fetchListeningHistory(userData.id); // Fetch history after login
            }
        }

        async function fetchListeningHistory(userId) {
            try {
                const response = await fetch('output.json'); // Load JSON
                const data = await response.json();

                
                
                const userTracks = data.filter(entry => entry.user_id === userId);
                const trackList = document.getElementById("track-list");

                if (userTracks.length === 0) {
                    trackList.innerHTML = "<p>No listening history found.</p>";
                } else {
                    userTracks.forEach(track => {
                        const listItem = document.createElement("li");
                        listItem.textContent = `${track.track_name} by ${track.artist_name} (Played ${track.count} times)`;
                        trackList.appendChild(listItem);
                    });
                }
            } catch (error) {
                console.error("Error loading JSON:", error);
            }
        }

        function logout() {
            localStorage.removeItem('spotify_token');
            localStorage.removeItem('spotify_user_id');
            location.reload();
        }

        document.getElementById('login-btn').addEventListener('click', initiateSpotifyLogin);
        document.getElementById('logout-btn').addEventListener('click', logout);

        // Check if user is already logged in
        const token = localStorage.getItem('spotify_token');
        const userId = localStorage.getItem('spotify_user_id');

        if (token && userId) {
            fetchUserProfile(token);
        } else {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) fetchAccessToken(code);
        }
        const storedUserId = localStorage.getItem('spotify_user_id');
        if (storedUserId) {
            document.getElementById('user-id').textContent = `User ID: ${storedUserId}`;
        }
    </script>
</body>
</html>
